
{# ------------------- table 2 : Summary by account ( readfrom GL Entry  ) -------------------- #}
{% set w_work_flag = "Yes" %} 
{% if doc.is_return == 1 %} {% set w_work_flag = "No" %} {% endif %}

{% if w_work_flag == "Yes" %}
<div class="margin-top">
<table class='table table-bordered table-condensed'>
    {% if doc.docstatus == 1 %}
        <caption><strong>Summary by account ( read from GL Entry ) </strong></caption>
    {% else %}
        <caption><strong>Draft summary, derived from Purchase Receipt </strong></caption>
    {% endif %}
    {% set adebit = [0] %}  
    {% set acredit = [0] %}
    {% set ll = [0] %}   
    <tr>
        <th>No.</th>
        <th>Account</th>
        <th>Debit Amount</th>
        <th>Credit Amount</th>
    </tr>

    {% if doc.docstatus == 1 %}
        {# --- read from GL Entry #}
        {# ------------------- each line from GL -------------------- #}
        {% set gl = frappe.db.sql("Select account, sum(debit) ddd, sum(credit) ccc 
                                From `tabGL Entry` 
                                WHERE voucher_no = %s and is_cancelled = 0
                                group by account 
                                order by sum(debit) desc, sum(credit) desc;", (doc.name), as_dict=1) %}
            {% for item in gl %}
                {% set cc = item.ccc %}
                {% set dd = item.ddd %}
                {% if ll.append(ll[-1]  + 1 )  %}{% endif %}
                <tr>
                    <td style="text-align:center">{{ ll[-1] }}</td>
                    <td>{{ item.account }}</td>
                    <td style="text-align:right">{{frappe.utils.fmt_money(dd)}}</td>
                    <td style="text-align:right">{{frappe.utils.fmt_money(cc)}}</td>
                </tr>
                {% if adebit.append  (adebit[-1]  + dd )  %}{% endif %}
                {% if acredit.append(acredit[-1]  + cc )  %}{% endif %}
            {% endfor %}
    {% else %}
        {# --- read from PR and PRi #}
        {# ------------------- each line from DNi -------------------- #}
        {% set pri = frappe.db.sql("Select landed_cost_voucher_amount 
                                From `tabPurchase Receipt Item` 
                                WHERE parent = %s ;", (doc.name), as_dict=1) %}
        {% set sum_amt = [0]  %}                        
        {% for item in pri %}
            {% if sum_amt.append(sum_amt[-1]  + item.landed_cost_voucher_amount)  %}{% endif %}
        {% endfor %}
        <tr>
            <td style="text-align:center">{{ ll[-1] }}</td>
            <td>{{ "115101 - สินค้าสำเร็จรูป - IGPCL" }}</td>
            <td style="text-align:right">{{frappe.utils.fmt_money(doc.base_net_total + sum_amt[-1])}}</td>
            <td style="text-align:right"></td>
        </tr>
        {% if adebit.append  (adebit[-1]  + doc.base_net_total + sum_amt[-1])  %}{% endif %}
        {% if ll.append(ll[-1]  + 1 )  %}{% endif %}
        <tr>
            <td style="text-align:center">{{ ll[-1] }}</td> 
            <td>{{ "122206 - Asset  Clearing - IGPCL" }}</td>
            <td style="text-align:right"></td>
            <td style="text-align:right">{{frappe.utils.fmt_money(doc.base_net_total)}}</td>
        </tr>
        {% if acredit.append(acredit[-1]  + doc.base_net_total )  %}{% endif %}
        {% if ll.append(ll[-1]  + 1 )  %}{% endif %}
        <tr>
            <td style="text-align:center">{{ ll[-1] }}</td>
            <td>{{ "Shipping Charges - IGPCL" }}</td>
            <td style="text-align:right"></td>
            <td style="text-align:right">{{frappe.utils.fmt_money(sum_amt[-1])}}</td>
        </tr>
        {% if acredit.append(acredit[-1]  + sum_amt[-1] )  %}{% endif %}
    {% endif %}

    {% if ll.append(ll[-1]  + 1 )  %}{% endif %}
    <tr>
        <td> </td>
        <td style="text-align:right"><strong> Total </strong></td>
        <td style="text-align:right"><strong> {{frappe.utils.fmt_money(adebit[-1])}} </strong></td>
        <td style="text-align:right"><strong> {{frappe.utils.fmt_money(acredit[-1])}} </strong></td>
    </tr>
</table>
</div>
{% endif %}